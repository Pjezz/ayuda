<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Tus Recomendaciones de Autos</title>
  <style>
    /* ===== RESET Y ESTILOS BASE ===== */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Arial', sans-serif;
    }

    body {
      background-color: #f5f5f5;
      padding: 20px;
      min-height: 100vh;
    }

    .container {
      background: white;
      border-radius: 15px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
      padding: 2rem;
      width: 100%;
      max-width: 1400px;
      margin: 0 auto;
    }

    /* ===== HEADER ===== */
    header {
      text-align: center;
      margin-bottom: 2rem;
    }

    header h1 {
      color: #333;
      font-size: 2rem;
      font-weight: 600;
      margin-bottom: 0.5rem;
    }

    .subtitle {
      color: #666;
      font-size: 1.1rem;
    }

    /* ===== DEBUG INFO ===== */
    .debug-info {
      background-color: #e7f3ff;
      border: 1px solid #b3d9ff;
      border-radius: 8px;
      padding: 1rem;
      margin-bottom: 2rem;
      font-family: monospace;
      font-size: 0.9rem;
      transition: all 0.3s ease;
    }

    /* ===== LOADING ===== */
    .loading {
      text-align: center;
      padding: 50px;
      font-size: 18px;
      color: #666;
    }

    .loading::after {
      content: '';
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid #f3f3f3;
      border-top: 3px solid #6200ea;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-left: 10px;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    /* ===== ERROR MESSAGE ===== */
    .error-message {
      background-color: #f8d7da;
      color: #721c24;
      padding: 20px;
      border-radius: 12px;
      margin: 20px 0;
      text-align: left;
      border: 1px solid #f5c6cb;
    }

    .error-message h3 {
      margin-bottom: 1rem;
      color: #721c24;
    }

    .error-message ul {
      margin: 1rem 0;
      padding-left: 1.5rem;
    }

    .error-message li {
      margin: 0.5rem 0;
    }

    .error-container {
      margin-bottom: 2rem;
    }

    /* ===== SUMMARY SECTION ===== */
    .summary-section {
      background: #f8f9fa;
      border-radius: 12px;
      padding: 1.5rem;
      margin-bottom: 2rem;
      border-left: 4px solid #6200ea;
    }

    .summary-section h3 {
      color: #333;
      margin-bottom: 1rem;
      font-size: 1.3rem;
    }

    .summary-stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 1rem;
      margin-bottom: 1rem;
    }

    .stat {
      text-align: center;
      padding: 1rem;
      background: white;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .stat-number {
      display: block;
      font-size: 1.5rem;
      font-weight: bold;
      color: #6200ea;
    }

    .stat-label {
      font-size: 0.9rem;
      color: #666;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .summary-details {
      margin-top: 1rem;
    }

    .summary-details p {
      margin: 0.5rem 0;
      color: #555;
    }

    /* ===== GRID DE RECOMENDACIONES ===== */
    .recommendations-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
      gap: 1.5rem;
      margin-bottom: 2rem;
    }

    /* ===== TARJETAS DE AUTOS ===== */
    .car-card {
      background: white;
      border: 2px solid #e0e0e0;
      border-radius: 12px;
      padding: 1.5rem;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      position: relative;
      overflow: hidden;
    }

    .car-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 4px;
      background: linear-gradient(90deg, #6200ea, #3700b3);
      opacity: 0;
      transition: opacity 0.3s ease;
    }

    .car-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
      border-color: #6200ea;
    }

    .car-card:hover::before {
      opacity: 1;
    }

    /* ===== IMAGEN DEL AUTO ===== */
    .car-image {
      margin-bottom: 1rem;
      border-radius: 8px;
      overflow: hidden;
    }

    .car-image img {
      width: 100%;
      height: 200px;
      object-fit: cover;
      transition: transform 0.3s ease;
    }

    .car-card:hover .car-image img {
      transform: scale(1.05);
    }

    .no-image {
      width: 100%;
      height: 200px;
      background: #f0f0f0;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 8px;
      color: #999;
      font-size: 14px;
      border: 2px dashed #ddd;
    }

    /* ===== INFORMACIÓN DEL AUTO ===== */
    .car-info {
      position: relative;
    }

    .car-name {
      font-size: 1.4rem;
      font-weight: bold;
      margin-bottom: 0.3rem;
      color: #333;
      line-height: 1.2;
    }

    .car-brand {
      color: #6200ea;
      font-size: 1rem;
      font-weight: 500;
      margin-bottom: 0.8rem;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .car-price {
      font-size: 1.3rem;
      font-weight: bold;
      color: #27ae60;
      margin-bottom: 1rem;
      padding: 0.5rem;
      background: rgba(39, 174, 96, 0.1);
      border-radius: 6px;
      text-align: center;
    }

    /* ===== PUNTUACIÓN DE SIMILITUD ===== */
    .similarity-score {
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: rgba(98, 0, 234, 0.1);
      padding: 0.5rem;
      border-radius: 6px;
      margin-bottom: 1rem;
    }

    .score-label {
      font-size: 0.9rem;
      color: #6200ea;
      font-weight: 500;
    }

    .score-value {
      font-size: 1.1rem;
      font-weight: bold;
      color: #6200ea;
    }

    /* ===== DETALLES DEL AUTO ===== */
    .car-details {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 0.5rem;
      margin-bottom: 1rem;
      padding: 1rem;
      background: #f8f9fa;
      border-radius: 8px;
    }

    .detail {
      font-size: 0.9rem;
      color: #555;
      padding: 0.3rem 0;
    }

    .detail strong {
      color: #333;
      font-weight: 600;
    }

    /* ===== CARACTERÍSTICAS ===== */
    .car-features {
      margin-top: 1rem;
    }

    .car-features h4 {
      color: #333;
      margin-bottom: 0.5rem;
      font-size: 1rem;
    }

    .car-features ul {
      list-style: none;
      padding: 0;
    }

    .car-features li {
      margin: 0.3rem 0;
      font-size: 0.9rem;
      color: #666;
      padding-left: 1rem;
      position: relative;
    }

    .car-features li::before {
      content: '✓';
      position: absolute;
      left: 0;
      color: #27ae60;
      font-weight: bold;
    }

    .more-features {
      font-style: italic;
      color: #999 !important;
    }

    /* ===== BOTONES DE ACCIÓN ===== */
    .action-buttons {
      text-align: center;
      padding: 2rem 0;
      display: flex;
      gap: 1rem;
      justify-content: center;
      flex-wrap: wrap;
      border-top: 1px solid #e0e0e0;
      margin-top: 2rem;
    }

    .restart-btn, .print-btn, .retry-btn {
      padding: 0.8rem 2rem;
      border: none;
      border-radius: 8px;
      font-size: 1rem;
      cursor: pointer;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      font-weight: 500;
      min-width: 140px;
    }

    .restart-btn {
      background-color: #6200ea;
      color: white;
    }

    .restart-btn:hover {
      background-color: #3700b3;
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(98, 0, 234, 0.3);
    }

    .print-btn {
      background-color: #95a5a6;
      color: white;
    }

    .print-btn:hover {
      background-color: #7f8c8d;
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(149, 165, 166, 0.3);
    }

    .retry-btn {
      background-color: #e74c3c;
      color: white;
    }

    .retry-btn:hover {
      background-color: #c0392b;
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(231, 76, 60, 0.3);
    }

    /* ===== NO RECOMMENDATIONS ===== */
    .no-recommendations {
      text-align: center;
      padding: 3rem;
      color: #666;
    }

    .no-recommendations h3 {
      color: #333;
      margin-bottom: 1rem;
      font-size: 1.5rem;
    }

    /* ===== RESPONSIVE ===== */
    @media (max-width: 768px) {
      .container {
        padding: 1.5rem;
      }
      
      .recommendations-grid {
        grid-template-columns: 1fr;
        gap: 1rem;
      }
      
      .car-details {
        grid-template-columns: 1fr;
      }
      
      .action-buttons {
        flex-direction: column;
        align-items: center;
        gap: 0.8rem;
      }
      
      .restart-btn, .print-btn, .retry-btn {
        width: 100%;
        max-width: 250px;
      }
      
      header h1 {
        font-size: 1.8rem;
      }

      .summary-stats {
        grid-template-columns: 1fr;
      }
    }

    @media (max-width: 480px) {
      .container {
        padding: 1rem;
      }
      
      .car-card {
        padding: 1rem;
      }
      
      .car-name {
        font-size: 1.2rem;
      }
      
      .car-price {
        font-size: 1.1rem;
      }
      
      header h1 {
        font-size: 1.6rem;
      }
    }

    /* ===== ANIMACIONES ADICIONALES ===== */
    @keyframes fadeInUp {
      from {
        opacity: 0;
        transform: translateY(30px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .car-card {
      animation: fadeInUp 0.6s ease forwards;
      opacity: 0;
    }

    /* ===== MODAL DE DETALLES ===== */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.8);
      z-index: 1000;
      display: flex;
      align-items: center;
      justify-content: center;
      opacity: 0;
      visibility: hidden;
      transition: all 0.3s ease;
    }

    .modal-overlay.active {
      opacity: 1;
      visibility: visible;
    }

    .modal-container {
      background: white;
      border-radius: 15px;
      width: 90%;
      max-width: 900px;
      max-height: 90vh;
      overflow-y: auto;
      transform: scale(0.7);
      transition: transform 0.3s ease;
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
    }

    .modal-overlay.active .modal-container {
      transform: scale(1);
    }

    .modal-header {
      background: linear-gradient(135deg, #6200ea, #3700b3);
      color: white;
      padding: 1.5rem;
      border-radius: 15px 15px 0 0;
      position: relative;
    }

    .modal-close {
      position: absolute;
      top: 1rem;
      right: 1rem;
      background: rgba(255, 255, 255, 0.2);
      border: none;
      color: white;
      font-size: 1.5rem;
      width: 40px;
      height: 40px;
      border-radius: 50%;
      cursor: pointer;
      transition: background 0.3s ease;
    }

    .modal-close:hover {
      background: rgba(255, 255, 255, 0.3);
    }

    .modal-car-title {
      font-size: 1.8rem;
      font-weight: bold;
      margin-bottom: 0.5rem;
    }

    .modal-car-subtitle {
      font-size: 1rem;
      opacity: 0.9;
    }

    .modal-body {
      padding: 2rem;
    }

    .modal-image-section {
      margin-bottom: 2rem;
      text-align: center;
    }

    .modal-main-image {
      width: 100%;
      max-width: 500px;
      height: 250px;
      object-fit: cover;
      border-radius: 12px;
      background: #f0f0f0;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #999;
      font-size: 1rem;
    }

    .modal-info-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 2rem;
      margin-bottom: 2rem;
    }

    .modal-info-section {
      background: #f8f9fa;
      padding: 1.5rem;
      border-radius: 12px;
    }

    .modal-info-section h3 {
      color: #333;
      margin-bottom: 1rem;
      font-size: 1.2rem;
      border-bottom: 2px solid #6200ea;
      padding-bottom: 0.5rem;
    }

    .modal-specs-table {
      width: 100%;
      border-collapse: collapse;
    }

    .modal-specs-table tr {
      border-bottom: 1px solid #e0e0e0;
    }

    .modal-specs-table td {
      padding: 0.8rem 0;
      vertical-align: top;
    }

    .modal-specs-table td:first-child {
      font-weight: 600;
      color: #555;
      width: 50%;
    }

    .modal-specs-table td:last-child {
      color: #333;
    }

    .modal-features-grid {
      display: grid;
      grid-template-columns: 1fr;
      gap: 0.5rem;
    }

    .modal-feature-item {
      display: flex;
      align-items: center;
      padding: 0.5rem;
      background: white;
      border-radius: 6px;
      border-left: 3px solid #6200ea;
    }

    .modal-feature-icon {
      color: #27ae60;
      margin-right: 0.5rem;
      font-weight: bold;
    }

    .modal-price-section {
      background: linear-gradient(135deg, #27ae60, #2ecc71);
      color: white;
      padding: 1.5rem;
      border-radius: 12px;
      text-align: center;
      margin: 1.5rem 0;
    }

    .modal-price-main {
      font-size: 2rem;
      font-weight: bold;
      margin-bottom: 0.5rem;
    }

    .modal-price-subtitle {
      font-size: 1rem;
      opacity: 0.9;
    }

    .modal-actions {
      display: flex;
      gap: 1rem;
      flex-wrap: wrap;
      margin-top: 1.5rem;
    }

    .modal-action-btn {
      flex: 1;
      min-width: 140px;
      padding: 0.8rem 1.5rem;
      border: none;
      border-radius: 8px;
      font-size: 0.9rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .modal-btn-primary {
      background: #6200ea;
      color: white;
    }

    .modal-btn-primary:hover {
      background: #3700b3;
      transform: translateY(-2px);
    }

    .modal-btn-secondary {
      background: #e0e0e0;
      color: #333;
    }

    .modal-btn-secondary:hover {
      background: #d0d0d0;
    }

    .details-btn {
      background: #17a2b8;
      color: white;
      border: none;
      padding: 0.6rem 1.2rem;
      border-radius: 6px;
      font-size: 0.9rem;
      cursor: pointer;
      transition: all 0.3s ease;
      margin-top: 1rem;
      width: 100%;
    }

    .details-btn:hover {
      background: #138496;
      transform: translateY(-1px);
    }

    /* Responsive para modal */
    @media (max-width: 768px) {
      .modal-container {
        width: 95%;
        margin: 1rem;
      }

      .modal-info-grid {
        grid-template-columns: 1fr;
        gap: 1rem;
      }

      .modal-body {
        padding: 1rem;
      }

      .modal-car-title {
        font-size: 1.4rem;
      }

      .modal-actions {
        flex-direction: column;
      }

      .modal-action-btn {
        min-width: auto;
      }
    }

    /* ===== PRINT STYLES ===== */
    @media print {
      .debug-info,
      .action-buttons {
        display: none !important;
      }
      
      .container {
        box-shadow: none;
        border-radius: 0;
      }
      
      .car-card {
        break-inside: avoid;
        box-shadow: none;
        border: 1px solid #ddd;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>Tus Recomendaciones Personalizadas</h1>
      <p class="subtitle">Basadas en tus preferencias seleccionadas</p>
    </header>

    <!-- Debug Info -->
    <div class="debug-info">
      <strong>Estado de Debug:</strong><br>
      CSS: ✓ Cargado directamente<br>
      JavaScript: <span id="js-status">⏳ Verificando...</span><br>
      API: <span id="api-status">⏳ Verificando...</span>
    </div>

    <!-- Loading indicator -->
    <div id="loading" class="loading" style="display: block;">
      Cargando tus recomendaciones...
    </div>

    <!-- Error container -->
    <div id="error-container" class="error-container" style="display: none;">
    </div>

    <!-- Summary section -->
    <div id="summary-section" class="summary-section" style="display: none;">
      <h3>📊 Resumen de tu búsqueda</h3>
      <div id="summary-content"></div>
    </div>

    <!-- Recommendations container -->
    <div id="recommendations-container" class="recommendations-container" style="display: none;">
    </div>

    <!-- Action buttons -->
    <div class="action-buttons" id="action-buttons" style="display: none;">
      <button onclick="restartProcess()" class="restart-btn">🔄 Empezar de Nuevo</button>
      <button onclick="window.print()" class="print-btn">🖨️ Imprimir</button>
      <button onclick="loadRecommendations()" class="retry-btn">🔁 Reintentar</button>
    </div>

    <!-- Modal de detalles del auto -->
    <div class="modal-overlay" id="carDetailModal">
      <div class="modal-container">
        <div class="modal-header">
          <button class="modal-close" onclick="closeCarDetailsModal()">&times;</button>
          <div class="modal-car-title" id="modalCarTitle">Detalles del Vehículo</div>
          <div class="modal-car-subtitle" id="modalCarSubtitle">Información completa</div>
        </div>
        <div class="modal-body" id="modalBody">
          <!-- Contenido se carga dinámicamente -->
        </div>
      </div>
    </div>
  </div>

  <script>
    // Variables globales
    let debugMode = false;

    // Función para formatear precio
    function formatPrice(price) {
      if (typeof price === 'number') {
        return `$${price.toLocaleString('es-GT')}`;
      }
      return price || 'Precio no disponible';
    }

    // Función para crear una tarjeta de auto
    function createCarCard(car, index) {
      const card = document.createElement('div');
      card.className = 'car-card';
      
      // Agregar delay de animación basado en el índice
      card.style.animationDelay = `${index * 0.1}s`;
      
      const imageHtml = car.image ? 
        `<div class="car-image"><img src="${car.image}" alt="${car.name}"></div>` :
        `<div class="car-image"><div class="no-image">📷 Imagen no disponible</div></div>`;
      
      const featuresHtml = car.features && Array.isArray(car.features) && car.features.length > 0 ? 
        `<div class="car-features">
           <h4>Características destacadas:</h4>
           <ul>
             ${car.features.slice(0, 5).map(feature => `<li>${feature}</li>`).join('')}
             ${car.features.length > 5 ? `<li class="more-features">+${car.features.length - 5} más características</li>` : ''}
           </ul>
         </div>` : '';
      
      // Mostrar puntuación de similitud si está disponible
      const scoreHtml = car.similarity_score ? 
        `<div class="similarity-score">
           <span class="score-label">Compatibilidad:</span>
           <span class="score-value">${Math.round(car.similarity_score)}%</span>
         </div>` : '';
      
      card.innerHTML = `
        ${imageHtml}
        <div class="car-info">
          <div class="car-name">${car.name || 'Nombre no disponible'}</div>
          <div class="car-brand">${car.brand || 'Marca no disponible'}</div>
          <div class="car-price">${formatPrice(car.price)}</div>
          ${scoreHtml}
          <div class="car-details">
            <div class="detail"><strong>Tipo:</strong> ${car.type || 'No especificado'}</div>
            <div class="detail"><strong>Combustible:</strong> ${car.fuel || 'No especificado'}</div>
            <div class="detail"><strong>Transmisión:</strong> ${car.transmission || 'No especificado'}</div>
            <div class="detail"><strong>Año:</strong> ${car.year || 'No especificado'}</div>
          </div>
          ${featuresHtml}
          <button onclick="openCarDetailsModal(${JSON.stringify(car).replace(/"/g, '&quot;')})" class="details-btn">
            🔍 Ver detalles completos
          </button>
        </div>
      `;
      
      return card;
    }

    // Función para mostrar las recomendaciones
    function displayRecommendations(recommendations) {
      const container = document.getElementById('recommendations-container');
      const summarySection = document.getElementById('summary-section');
      const summaryContent = document.getElementById('summary-content');
      
      if (!Array.isArray(recommendations) || recommendations.length === 0) {
        container.innerHTML = `
          <div class="no-recommendations">
            <h3>No se encontraron recomendaciones</h3>
            <p>Lo sentimos, no pudimos encontrar autos que coincidan con tus preferencias.</p>
            <p>Intenta modificar tus criterios de búsqueda.</p>
          </div>
        `;
        return;
      }
      
      const grid = document.createElement('div');
      grid.className = 'recommendations-grid';
      
      // Mostrar hasta 10 recomendaciones
      const displayCount = Math.min(recommendations.length, 10);
      
      recommendations.slice(0, displayCount).forEach((car, index) => {
        const card = createCarCard(car, index);
        grid.appendChild(card);
      });
      
      container.innerHTML = '';
      container.appendChild(grid);
      
      // Mostrar resumen de la búsqueda
      if (summaryContent) {
        const priceRange = recommendations.length > 0 ? {
          min: Math.min(...recommendations.map(c => c.price)),
          max: Math.max(...recommendations.map(c => c.price))
        } : { min: 0, max: 0 };
        
        const brands = [...new Set(recommendations.map(c => c.brand))];
        const types = [...new Set(recommendations.map(c => c.type))];
        
        summaryContent.innerHTML = `
          <div class="summary-stats">
            <div class="stat">
              <span class="stat-number">${displayCount}</span>
              <span class="stat-label">recomendaciones encontradas</span>
            </div>
            <div class="stat">
              <span class="stat-number">${brands.length}</span>
              <span class="stat-label">marcas diferentes</span>
            </div>
            <div class="stat">
              <span class="stat-number">$${priceRange.min.toLocaleString()} - $${priceRange.max.toLocaleString()}</span>
              <span class="stat-label">rango de precios</span>
            </div>
          </div>
          <div class="summary-details">
            <p><strong>Marcas encontradas:</strong> ${brands.join(', ')}</p>
            <p><strong>Tipos disponibles:</strong> ${types.join(', ')}</p>
          </div>
        `;
        
        summarySection.style.display = 'block';
      }
    }

    // Función para mostrar errores
    function showError(errorMessage, details = null) {
      const errorContainer = document.getElementById('error-container');
      const loadingElement = document.getElementById('loading');
      
      if (loadingElement) {
        loadingElement.style.display = 'none';
      }
      
      let errorHtml = `
        <div class="error-message">
          <h3>❌ Error al cargar las recomendaciones</h3>
          <p><strong>Mensaje:</strong> ${errorMessage}</p>
      `;
      
      if (details) {
        errorHtml += `
          <p><strong>Posibles soluciones:</strong></p>
          <ul>
            <li>Verifica que hayas completado todos los pasos anteriores</li>
            <li>Intenta recargar la página</li>
            <li>Si el problema persiste, reinicia el proceso</li>
          </ul>
        `;
      }
      
      errorHtml += `</div>`;
      
      errorContainer.innerHTML = errorHtml;
      errorContainer.style.display = 'block';
    }

    // Función para cargar las recomendaciones
    async function loadRecommendations() {
      const loadingElement = document.getElementById('loading');
      const recommendationsContainer = document.getElementById('recommendations-container');
      const errorContainer = document.getElementById('error-container');
      const actionButtons = document.getElementById('action-buttons');
      const summarySection = document.getElementById('summary-section');
      
      try {
        // Mostrar loading y ocultar otros elementos
        if (loadingElement) loadingElement.style.display = 'block';
        if (recommendationsContainer) recommendationsContainer.style.display = 'none';
        if (errorContainer) errorContainer.style.display = 'none';
        if (actionButtons) actionButtons.style.display = 'none';
        if (summarySection) summarySection.style.display = 'none';

        // Obtener recomendaciones del servidor
        console.log('Intentando conectar con /api/recommendations...');
        const apiStatus = document.getElementById('api-status');
        if (apiStatus) {
          apiStatus.textContent = '⏳ Conectando...';
        }
        
        const response = await fetch('/api/recommendations');
        
        console.log('Respuesta recibida:', response.status, response.statusText);
        
        if (!response.ok) {
          if (apiStatus) {
            apiStatus.textContent = `❌ Error ${response.status}`;
          }
          
          // Intentar obtener el mensaje de error del servidor
          let errorMessage = `Error ${response.status}: ${response.statusText}`;
          let errorDetails = null;
          
          try {
            const errorData = await response.json();
            errorMessage = errorData.error || errorMessage;
            errorDetails = errorData;
          } catch (e) {
            console.log('No se pudo parsear el error JSON');
          }
          
          showError(errorMessage, errorDetails);
          return;
        }
        
        const recommendations = await response.json();
        console.log('Recomendaciones recibidas:', recommendations);
        
        if (apiStatus) {
          apiStatus.textContent = '✓ Conectado';
        }
        
        // Ocultar loading y mostrar recomendaciones
        if (loadingElement) loadingElement.style.display = 'none';
        if (recommendationsContainer) recommendationsContainer.style.display = 'block';
        if (actionButtons) actionButtons.style.display = 'flex';
        
        // Verificar que las recomendaciones sean válidas
        if (!Array.isArray(recommendations)) {
          console.error('Las recomendaciones no son un array:', recommendations);
          showError('Formato de datos inválido recibido del servidor');
          return;
        }
        
        // Mostrar las recomendaciones
        displayRecommendations(recommendations);
        
      } catch (error) {
        console.error('Error cargando recomendaciones:', error);
        
        const apiStatus = document.getElementById('api-status');
        if (apiStatus) {
          apiStatus.textContent = '❌ Error de conexión';
        }
        
        showError(`Error de conexión: ${error.message}`, {
          suggestion: 'Verifica que el servidor esté funcionando correctamente'
        });
        
        // Mostrar botones de acción para que el usuario pueda reintentar
        if (actionButtons) actionButtons.style.display = 'flex';
      }
    }

    // Función para reiniciar el proceso
    function restartProcess() {
      if (confirm('¿Estás seguro de que quieres reiniciar el proceso? Se perderán todas tus selecciones.')) {
        window.location.href = '/brands';
      }
    }

    // Función para probar con datos de ejemplo
    function testWithMockData() {
      const mockRecommendations = [
        {
          name: "Toyota Corolla 2024",
          brand: "Toyota",
          price: 25000,
          type: "Sedán",
          fuel: "Gasolina",
          transmission: "Automática",
          features: ["Aire acondicionado", "Sistema de sonido", "Cámara trasera"],
          similarity_score: 85.0
        },
        {
          name: "Honda Civic 2024",
          brand: "Honda",
          price: 28000,
          type: "Sedán",
          fuel: "Gasolina",
          transmission: "Manual",
          features: ["Pantalla táctil", "Sensores de estacionamiento", "Control crucero"],
          similarity_score: 80.0
        }
      ];
      
      document.getElementById('loading').style.display = 'none';
      document.getElementById('error-container').style.display = 'none';
      document.getElementById('api-status').textContent = '🧪 Datos de prueba';
      
      displayRecommendations(mockRecommendations);
    }

    // Función principal que se ejecuta cuando carga la página
    document.addEventListener('DOMContentLoaded', async () => {
      // Marcar JavaScript como cargado
      const jsStatus = document.getElementById('js-status');
      if (jsStatus) {
        jsStatus.textContent = '✓ Cargado';
      }

      // Cargar las recomendaciones automáticamente
      await loadRecommendations();
    });

    // Hacer las funciones disponibles globalmente para los botones
    window.loadRecommendations = loadRecommendations;
    window.restartProcess = restartProcess;
    window.testWithMockData = testWithMockData;
    window.openCarDetailsModal = openCarDetailsModal;
    window.closeCarDetailsModal = closeCarDetailsModal;

    // ===== FUNCIONES DEL MODAL DE DETALLES =====

    function openCarDetailsModal(carData) {
      const modal = document.getElementById('carDetailModal');
      const modalBody = document.getElementById('modalBody');
      const title = document.getElementById('modalCarTitle');
      const subtitle = document.getElementById('modalCarSubtitle');

      // Mostrar modal
      modal.classList.add('active');
      document.body.style.overflow = 'hidden';

      // Actualizar título
      title.textContent = carData.name || 'Información del Vehículo';
      subtitle.textContent = `${carData.brand} • ${carData.year} • ${formatPrice(carData.price)}`;

      // Generar contenido
      modalBody.innerHTML = generateDetailedModalContent(carData);
    }

    function closeCarDetailsModal() {
      const modal = document.getElementById('carDetailModal');
      modal.classList.remove('active');
      document.body.style.overflow = 'auto';
    }

    function generateDetailedModalContent(car) {
      const specs = generateCarSpecs(car);
      const financing = calculateFinancing(car.price);

      return `
        <!-- Imagen principal -->
        <div class="modal-image-section">
          <div class="modal-main-image">
            📷 Imagen de ${car.name}
          </div>
        </div>

        <!-- Grid de información -->
        <div class="modal-info-grid">
          <!-- Especificaciones -->
          <div class="modal-info-section">
            <h3>📋 Especificaciones Técnicas</h3>
            <table class="modal-specs-table">
              ${specs.map(spec => `
                <tr>
                  <td>${spec.label}:</td>
                  <td>${spec.value}</td>
                </tr>
              `).join('')}
            </table>
          </div>

          <!-- Características -->
          <div class="modal-info-section">
            <h3>✨ Características Incluidas</h3>
            <div class="modal-features-grid">
              ${(car.features || ['Aire acondicionado', 'Radio AM/FM', 'Bluetooth']).map(feature => `
                <div class="modal-feature-item">
                  <span class="modal-feature-icon">✓</span>
                  <span>${feature}</span>
                </div>
              `).join('')}
            </div>
          </div>
        </div>

        <!-- Sección de precio -->
        <div class="modal-price-section">
          <div class="modal-price-main">${formatPrice(car.price)}</div>
          <div class="modal-price-subtitle">Precio sugerido al público</div>
          <div style="margin-top: 1rem; font-size: 0.9rem;">
            <strong>Financiamiento estimado:</strong> ${financing.monthly}/mes a ${financing.term} meses
          </div>
        </div>

        <!-- Acciones -->
        <div class="modal-actions">
          <button class="modal-action-btn modal-btn-primary" onclick="requestQuote('${car.id}')">
            💰 Solicitar Cotización
          </button>
          <button class="modal-action-btn modal-btn-secondary" onclick="addToFavorites('${car.id}')">
            ❤️ Favoritos
          </button>
          <button class="modal-action-btn modal-btn-secondary" onclick="shareVehicle('${car.id}')">
            🔗 Compartir
          </button>
        </div>
      `;
    }

    function generateCarSpecs(car) {
      return [
        { label: 'Marca', value: car.brand || 'N/A' },
        { label: 'Modelo', value: car.model || 'N/A' },
        { label: 'Año', value: car.year || 'N/A' },
        { label: 'Tipo de Vehículo', value: car.type || 'N/A' },
        { label: 'Combustible', value: car.fuel || 'N/A' },
        { label: 'Transmisión', value: car.transmission || 'N/A' },
        { label: 'Motor', value: getEngineInfo(car.fuel) },
        { label: 'Potencia', value: getPowerInfo(car.type) },
        { label: 'Rendimiento', value: getFuelEconomy(car.fuel) },
        { label: 'Capacidad', value: getCapacity(car.type) }
      ];
    }

    function getEngineInfo(fuel) {
      const engines = {
        'Gasolina': '2.0L 4 cilindros',
        'Diésel': '2.0L 4 cilindros Turbo Diésel',
        'Eléctrico': 'Motor eléctrico',
        'Híbrido': '1.8L 4 cilindros + Motor eléctrico'
      };
      return engines[fuel] || '2.0L 4 cilindros';
    }

    function getPowerInfo(type) {
      const power = {
        'Sedán': '150-180 HP',
        'SUV': '180-250 HP',
        'Pickup': '200-300 HP',
        'Coupé': '200-350 HP',
        'Hatchback': '120-150 HP'
      };
      return power[type] || '150 HP';
    }

    function getFuelEconomy(fuel) {
      const economy = {
        'Gasolina': '12-15 km/l',
        'Diésel': '18-22 km/l',
        'Eléctrico': '400-500 km por carga',
        'Híbrido': '20-25 km/l'
      };
      return economy[fuel] || '12-15 km/l';
    }

    function getCapacity(type) {
      const capacity = {
        'Sedán': '5 pasajeros',
        'SUV': '7 pasajeros',
        'Pickup': '5 pasajeros + carga',
        'Coupé': '4 pasajeros',
        'Hatchback': '5 pasajeros'
      };
      return capacity[type] || '5 pasajeros';
    }

    function calculateFinancing(price) {
      const downPaymentPercent = 0.2;
      const interestRate = 0.08;
      const termMonths = 48;
      
      const downPayment = price * downPaymentPercent;
      const loanAmount = price - downPayment;
      const monthlyRate = interestRate / 12;
      const monthly = (loanAmount * monthlyRate * Math.pow(1 + monthlyRate, termMonths)) / 
                     (Math.pow(1 + monthlyRate, termMonths) - 1);

      return {
        monthly: Math.round(monthly).toLocaleString(),
        downPayment: formatPrice(downPayment),
        term: termMonths
      };
    }

    // Funciones de acción (placeholder)
    function requestQuote(carId) {
      alert(`🚗 Cotización solicitada para el vehículo ${carId}\n\n¡Un asesor se contactará contigo pronto!`);
    }

    function addToFavorites(carId) {
      alert(`❤️ Vehículo ${carId} agregado a favoritos\n\n¡Podrás verlo en tu lista de favoritos!`);
    }

    function shareVehicle(carId) {
      if (navigator.share) {
        navigator.share({
          title: 'Mira este auto que encontré',
          text: 'Te recomiendo este vehículo del sistema de recomendaciones',
          url: window.location.href
        });
      } else {
        // Fallback: copiar al portapapeles
        navigator.clipboard.writeText(window.location.href).then(() => {
          alert('🔗 Enlace copiado al portapapeles');
        });
      }
    }

    // Cerrar modal con Escape
    document.addEventListener('keydown', function(e) {
      if (e.key === 'Escape') {
        closeCarDetailsModal();
      }
    });

    // Cerrar modal haciendo clic fuera
    document.addEventListener('click', function(e) {
      if (e.target && e.target.id === 'carDetailModal') {
        closeCarDetailsModal();
      }
    });
  </script>
</body>
</html>