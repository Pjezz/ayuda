from flask import Flask, request, jsonify, render_template, session, redirect, url_for
from flask_cors import CORS
import traceback

# Importar el sistema de recomendaciones
try:
    from recommender_minimal import get_recommendations
    RECOMMENDER_AVAILABLE = True
    print("‚úÖ Usando recommender_minimal.py")
except ImportError as e:
    try:
        from recommender import get_recommendations
        RECOMMENDER_AVAILABLE = True
        print("‚úÖ Usando recommender.py")
    except ImportError as e2:
        print(f"‚ùå Warning: No se pudo importar sistema de recomendaciones: {e2}")
        RECOMMENDER_AVAILABLE = False

app = Flask(__name__)
CORS(app)
app.secret_key = 'tu_clave_secreta_aqui_cambiala_por_una_segura'

@app.route("/")
def index():
    return render_template("index.html")

@app.route("/login", methods=["GET", "POST"])
def login():
    if request.method == "POST":
        data = request.get_json()
        username = data.get("username")
        password = data.get("password")
        
        # Aqu√≠ puedes agregar validaci√≥n real de usuario/contrase√±a
        if username and password:
            session['logged_in'] = True
            session['username'] = username
            print(f"‚úÖ Usuario logueado: {username}")
            return jsonify({"success": True, "redirect": url_for("brands")})
        else:
            return jsonify({"success": False, "message": "Credenciales inv√°lidas"})
    
    return render_template("login.html")

@app.route("/brands")
def brands():
    if not session.get('logged_in'):
        return redirect(url_for('login'))
    return render_template("brands.html")

@app.route("/budget")
def budget():
    if not session.get('logged_in'):
        return redirect(url_for('login'))
    if not session.get('selected_brands'):
        return redirect(url_for('brands'))
    return render_template("budget.html")

@app.route("/fuel")
def fuel():
    if not session.get('logged_in'):
        return redirect(url_for('login'))
    if not session.get('selected_budget'):
        return redirect(url_for('budget'))
    return render_template("fuel.html")

@app.route("/type")
def type_page():
    if not session.get('logged_in'):
        return redirect(url_for('login'))
    if not session.get('selected_fuel'):
        return redirect(url_for('fuel'))
    return render_template("type.html")

@app.route("/transmission")
def transmission():
    if not session.get('logged_in'):
        return redirect(url_for('login'))
    if not session.get('selected_types'):
        return redirect(url_for('type_page'))
    return render_template("transmission.html")

@app.route("/recommendations")
def recommendations():
    if not session.get('logged_in'):
        return redirect(url_for('login'))
    if not session.get('selected_transmission'):
        return redirect(url_for('transmission'))
    return render_template("recommendations.html")

# API Endpoints para guardar selecciones
@app.route("/api/save-brands", methods=["POST"])
def save_brands():
    try:
        data = request.get_json()
        brands_data = data.get('brands')
        print(f"üè∑Ô∏è Guardando brands: {brands_data}")
        session['selected_brands'] = brands_data
        return jsonify({"success": True})
    except Exception as e:
        print(f"‚ùå Error guardando brands: {e}")
        return jsonify({"success": False, "error": str(e)}), 500

@app.route("/api/save-budget", methods=["POST"])
def save_budget():
    try:
        data = request.get_json()
        budget_data = data.get('budget')
        print(f"üí∞ Guardando budget: {budget_data}")
        session['selected_budget'] = budget_data
        return jsonify({"success": True})
    except Exception as e:
        print(f"‚ùå Error guardando budget: {e}")
        return jsonify({"success": False, "error": str(e)}), 500

@app.route("/api/save-fuel", methods=["POST"])
def save_fuel():
    try:
        data = request.get_json()
        fuel_data = data.get('fuel')
        print(f"‚õΩ Guardando fuel: {fuel_data}")
        session['selected_fuel'] = fuel_data
        return jsonify({"success": True})
    except Exception as e:
        print(f"‚ùå Error guardando fuel: {e}")
        return jsonify({"success": False, "error": str(e)}), 500

@app.route("/api/save-types", methods=["POST"])
def save_types():
    try:
        data = request.get_json()
        types_data = data.get('types')
        print(f"üöó Guardando types: {types_data}")
        session['selected_types'] = types_data
        return jsonify({"success": True})
    except Exception as e:
        print(f"‚ùå Error guardando types: {e}")
        return jsonify({"success": False, "error": str(e)}), 500

@app.route("/api/save-transmission", methods=["POST"])
def save_transmission():
    try:
        data = request.get_json()
        transmission_data = data.get('transmission')
        print(f"‚öôÔ∏è Guardando transmission: {transmission_data}")
        session['selected_transmission'] = transmission_data
        return jsonify({"success": True})
    except Exception as e:
        print(f"‚ùå Error guardando transmission: {e}")
        return jsonify({"success": False, "error": str(e)}), 500

@app.route("/api/recommendations", methods=["GET"])
def api_recommendations():
    try:
        print("\n" + "="*60)
        print("üéØ API RECOMMENDATIONS - INICIANDO")
        print("="*60)
        
        # Obtener datos de la sesi√≥n
        brands = session.get('selected_brands')
        budget = session.get('selected_budget')
        fuel = session.get('selected_fuel')
        types = session.get('selected_types')
        transmission = session.get('selected_transmission')
        
        # Debug detallado
        print("üìä DATOS DE SESI√ìN:")
        print(f"  üè∑Ô∏è  Brands: {brands} (tipo: {type(brands)})")
        print(f"  üí∞ Budget: {budget} (tipo: {type(budget)})")
        print(f"  ‚õΩ Fuel: {fuel} (tipo: {type(fuel)})")
        print(f"  üöó Types: {types} (tipo: {type(types)})")
        print(f"  ‚öôÔ∏è  Transmission: {transmission} (tipo: {type(transmission)})")
        print(f"  üë§ Usuario: {session.get('username', 'N/A')}")
        
        # Verificar que todos los datos est√©n presentes
        missing_data = []
        if not brands: missing_data.append("brands")
        if not budget: missing_data.append("budget")
        if not fuel: missing_data.append("fuel")
        if not types: missing_data.append("types")
        if not transmission: missing_data.append("transmission")
        
        if missing_data:
            print(f"‚ùå FALTAN DATOS: {', '.join(missing_data)}")
            return jsonify({
                "error": f"Faltan datos de selecci√≥n: {', '.join(missing_data)}",
                "session_data": {
                    "brands": brands,
                    "budget": budget,
                    "fuel": fuel,
                    "types": types,
                    "transmission": transmission
                },
                "missing": missing_data
            }), 400
        
        print("‚úÖ TODOS LOS DATOS PRESENTES")
        
        # Si el sistema de recomendaciones no est√° disponible, usar datos de ejemplo
        if not RECOMMENDER_AVAILABLE:
            print("‚ö†Ô∏è RECOMMENDER NO DISPONIBLE - Usando datos de ejemplo")
            sample_recommendations = [
                {
                    "id": "sample_1",
                    "name": "Toyota Corolla 2024",
                    "model": "Corolla",
                    "brand": "Toyota",
                    "year": 2024,
                    "price": 25000,
                    "type": "Sed√°n",
                    "fuel": "Gasolina",
                    "transmission": "Autom√°tica",
                    "features": ["Aire acondicionado", "Radio AM/FM", "Bluetooth"],
                    "similarity_score": 85.0,
                    "image": None
                },
                {
                    "id": "sample_2",
                    "name": "Honda Civic 2024",
                    "model": "Civic",
                    "brand": "Honda",
                    "year": 2024,
                    "price": 27000,
                    "type": "Sed√°n",
                    "fuel": "Gasolina",
                    "transmission": "Manual",
                    "features": ["Pantalla t√°ctil", "Bluetooth", "Control crucero"],
                    "similarity_score": 80.0,
                    "image": None
                },
                {
                    "id": "sample_3",
                    "name": "BMW 3 Series 2024",
                    "model": "3 Series",
                    "brand": "BMW",
                    "year": 2024,
                    "price": 45000,
                    "type": "Sed√°n",
                    "fuel": "Gasolina",
                    "transmission": "Autom√°tica",
                    "features": ["Asientos de cuero", "Sistema premium", "Faros LED"],
                    "similarity_score": 75.0,
                    "image": None
                },
                {
                    "id": "sample_4",
                    "name": "Tesla Model Y 2024",
                    "model": "Model Y",
                    "brand": "Tesla",
                    "year": 2024,
                    "price": 48000,
                    "type": "SUV",
                    "fuel": "El√©ctrico",
                    "transmission": "Autom√°tica",
                    "features": ["Piloto autom√°tico", "Techo panor√°mico", "Supercargador"],
                    "similarity_score": 70.0,
                    "image": None
                },
                {
                    "id": "sample_5",
                    "name": "Ford F-150 2024",
                    "model": "F-150",
                    "brand": "Ford",
                    "year": 2024,
                    "price": 45000,
                    "type": "Pickup",
                    "fuel": "Gasolina",
                    "transmission": "Autom√°tica",
                    "features": ["Tracci√≥n 4x4", "Caja de aluminio", "Remolque"],
                    "similarity_score": 68.0,
                    "image": None
                },
                {
                    "id": "sample_6",
                    "name": "Audi A4 2024",
                    "model": "A4",
                    "brand": "Audi",
                    "year": 2024,
                    "price": 42000,
                    "type": "Sed√°n",
                    "fuel": "Gasolina",
                    "transmission": "Autom√°tica",
                    "features": ["Quattro AWD", "Virtual cockpit", "Premium sound"],
                    "similarity_score": 65.0,
                    "image": None
                },
                {
                    "id": "sample_7",
                    "name": "Nissan Rogue 2024",
                    "model": "Rogue",
                    "brand": "Nissan",
                    "year": 2024,
                    "price": 35000,
                    "type": "SUV",
                    "fuel": "Gasolina",
                    "transmission": "Autom√°tica",
                    "features": ["ProPILOT Assist", "Bose audio", "Panoramic roof"],
                    "similarity_score": 62.0,
                    "image": None
                },
                {
                    "id": "sample_8",
                    "name": "Hyundai Sonata 2024",
                    "model": "Sonata",
                    "brand": "Hyundai",
                    "year": 2024,
                    "price": 28000,
                    "type": "Sed√°n",
                    "fuel": "H√≠brido",
                    "transmission": "Autom√°tica",
                    "features": ["Digital key", "Wireless charging", "SmartSense"],
                    "similarity_score": 60.0,
                    "image": None
                }
            ]
            return jsonify(sample_recommendations)
        
        print("üîç Llamando a get_recommendations...")
        print(f"  Par√°metros enviados:")
        print(f"    brands={brands}")
        print(f"    budget={budget}")
        print(f"    fuel={fuel}")
        print(f"    types={types}")
        print(f"    transmission={transmission}")
        
        # Usar el sistema de recomendaciones real
        result = get_recommendations(brands, budget, fuel, types, transmission)
        
        print(f"üìã Resultado recibido:")
        print(f"  Tipo: {type(result)}")
        print(f"  Cantidad: {len(result) if isinstance(result, list) else 'N/A'}")
        if result and isinstance(result, list):
            print(f"  Primer elemento: {result[0].get('name', 'Sin nombre') if result[0] else 'Vac√≠o'}")
        
        # Asegurar que el resultado sea una lista
        if not isinstance(result, list):
            print(f"‚ö†Ô∏è get_recommendations devolvi√≥ {type(result)}, esperaba lista")
            return jsonify([])
        
        print(f"üéâ √âXITO: Devolviendo {len(result)} recomendaciones")
        print("="*60)
        
        return jsonify(result)
        
    except Exception as e:
        # Log completo del error
        error_traceback = traceback.format_exc()
        print(f"üí• ERROR en api_recommendations:")
        print(error_traceback)
        
        return jsonify({
            "error": f"Error interno del servidor: {str(e)}",
            "details": "Revisa la consola del servidor para m√°s informaci√≥n"
        }), 500

# Endpoint adicional para debug
@app.route("/api/debug/session", methods=["GET"])
def debug_session():
    session_data = dict(session)
    debug_info = {
        "session_data": session_data,
        "session_keys": list(session_data.keys()),
        "recommender_available": RECOMMENDER_AVAILABLE,
        "all_present": all([
            session.get('selected_brands'),
            session.get('selected_budget'),
            session.get('selected_fuel'),
            session.get('selected_types'),
            session.get('selected_transmission')
        ])
    }
    print(f"üîç Debug session solicitado: {debug_info}")
    return jsonify(debug_info)

# Endpoint para limpiar la sesi√≥n (√∫til para testing)
@app.route("/api/debug/clear-session", methods=["POST"])
def clear_session():
    session.clear()
    print("üßπ Sesi√≥n limpiada")
    return jsonify({"success": True, "message": "Sesi√≥n limpiada"})

# Endpoint para verificar estado del sistema
@app.route("/api/debug/system-status", methods=["GET"])
def system_status():
    status = {
        "flask": "‚úÖ Funcionando",
        "recommender": "‚úÖ Disponible" if RECOMMENDER_AVAILABLE else "‚ùå No disponible",
        "session_active": "‚úÖ Activa" if session.get('logged_in') else "‚ùå No logueado"
    }
    
    if RECOMMENDER_AVAILABLE:
        try:
            # Probar una recomendaci√≥n simple
            test_result = get_recommendations(brands=["Toyota"], budget="20000-50000")
            status["recommender_test"] = f"‚úÖ Funcionando ({len(test_result)} resultados)"
        except Exception as e:
            status["recommender_test"] = f"‚ùå Error: {str(e)}"
    
    return jsonify(status)

@app.route("/logout")
def logout():
    username = session.get('username', 'Usuario')
    session.clear()
    print(f"üëã Usuario {username} cerr√≥ sesi√≥n")
    return redirect(url_for('login'))

# Manejador de errores
@app.errorhandler(404)
def not_found(error):
    return jsonify({"error": "Endpoint no encontrado"}), 404

@app.errorhandler(500)
def internal_error(error):
    return jsonify({"error": "Error interno del servidor"}), 500

if __name__ == "__main__":
    print("=" * 60)
    print("üöÄ INICIANDO APLICACI√ìN FLASK")
    print("=" * 60)
    print(f"‚úÖ Recommender disponible: {RECOMMENDER_AVAILABLE}")
    print("üìã Endpoints disponibles:")
    print("  üè† GET  / -> index/login")
    print("  üè∑Ô∏è  GET  /brands -> selecci√≥n de marcas")
    print("  üí∞ GET  /budget -> selecci√≥n de presupuesto")
    print("  ‚õΩ GET  /fuel -> selecci√≥n de combustible")
    print("  üöó GET  /type -> selecci√≥n de tipo")
    print("  ‚öôÔ∏è  GET  /transmission -> selecci√≥n de transmisi√≥n")
    print("  üéØ GET  /recommendations -> p√°gina de recomendaciones")
    print("  üìä GET  /api/recommendations -> obtener recomendaciones JSON")
    print("  üîç GET  /api/debug/session -> ver datos de sesi√≥n")
    print("  üìà GET  /api/debug/system-status -> estado del sistema")
    print("=" * 60)
    app.run(debug=True, port=5000)